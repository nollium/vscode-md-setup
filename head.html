<!-- The content below will be included at the end of the <head> element. -->
<script type="text/javascript">
  const DELAY = 200;
  document.addEventListener("DOMContentLoaded", async function () {


    

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    let figureCount = 0;
    let isZoomed = false;

    async function processImages() {
      await sleep(DELAY);
      document.querySelectorAll('img').forEach(img => {
        // Skip if image is already processed
        if (img.parentNode.tagName === 'FIGURE') return;

        figureCount++;

        // Create and add caption
        const caption = document.createElement('figcaption');
        caption.textContent = `Image ${figureCount}: ${img.alt}`;
        const figure = document.createElement('figure');
        figure.style.textAlign = 'center';

        // Add copy button
        const copyButton = document.createElement('button');
        copyButton.className = 'img-copy-button';
        copyButton.textContent = 'Copy';
        copyButton.addEventListener('click', async () => {
          try {
            // Create a canvas and draw the image on it
            const canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            
            // Get the image as blob
            const blob = await new Promise(resolve => canvas.toBlob(resolve));
            
            // Copy to clipboard
            await navigator.clipboard.write([
              new ClipboardItem({
                [blob.type]: blob
              })
            ]);
            
            // Visual feedback
            copyButton.textContent = 'Copied!';
            setTimeout(() => {
              copyButton.textContent = 'Copy';
            }, 2000);
          } catch (err) {
            console.error('Failed to copy image:', err);
            copyButton.textContent = 'Error!';
            setTimeout(() => {
              copyButton.textContent = 'Copy';
            }, 2000);
          }
        });

        img.parentNode.insertBefore(figure, img);
        figure.appendChild(copyButton);
        figure.appendChild(img);
        figure.appendChild(caption);
        
        // Remove any existing event listener
        img.replaceWith(img.cloneNode(true));
        const newImg = figure.querySelector('img');

        // Apply base styles
        newImg.style.display = 'block';
        newImg.style.marginLeft = 'auto';
        newImg.style.marginRight = 'auto';
        newImg.style.border = '1px solid #ddd';
        newImg.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
        newImg.style.borderRadius = '4px';
        newImg.style.cursor = 'zoom-in';
        newImg.style.transition = 'none';

        // Handle zoom functionality
        newImg.addEventListener('mousedown', (e) => {
          const rect = newImg.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width) * 100;
          const y = ((e.clientY - rect.top) / rect.height) * 100;
          
          if (!isZoomed) {
            newImg.style.transform = 'scale(2)';
            newImg.style.transformOrigin = `${x}% ${y}%`;
            newImg.style.cursor = 'zoom-out';
            newImg.style.position = 'relative';
            newImg.style.zIndex = '999';
            isZoomed = true;
          } else {
            newImg.style.transform = 'scale(1)';
            newImg.style.cursor = 'zoom-in';
            newImg.style.position = 'static';
            newImg.style.zIndex = 'auto';
            isZoomed = false;
          }
        });
      });
    }

    // Add new function to handle code blocks
    async function processCodeBlocks() {
      document.querySelectorAll('pre[data-role="codeBlock"]').forEach(block => {
        // Skip if already processed
        if (block.querySelector('.copy-button')) return;

        const button = document.createElement('button');
        button.className = 'copy-button';
        button.textContent = 'Copy';
        
        button.addEventListener('click', async () => {
          const code = block.querySelector('code').textContent;
          await navigator.clipboard.writeText(code);
          
          // Visual feedback
          button.textContent = 'Copied!';
          setTimeout(() => {
            button.textContent = 'Copy';
          }, 2000);
        });

        block.appendChild(button);
      });
    }

    // Initial processing
    await sleep(DELAY);
    await processImages();
    await processCodeBlocks();

    // Update mutation observer
    const observer = new MutationObserver(async (mutations) => {
      for (const mutation of mutations) {
        if (mutation.type === 'childList') {
          const hasNewImages = Array.from(mutation.addedNodes).some(node => 
            node.nodeName === 'IMG' || (node.nodeType === 1 && node.querySelector('img'))
          );
          const hasNewCodeBlocks = Array.from(mutation.addedNodes).some(node =>
            node.nodeName === 'PRE' || (node.nodeType === 1 && node.querySelector('pre[data-role="codeBlock"]'))
          );
          
          if (hasNewImages) {
            figureCount = 0;
            await processImages();
          }
          if (hasNewCodeBlocks) {
            await processCodeBlocks();
          }
        }
      }
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  });
</script>

<style>
  figure {
    margin: 1em 0;
  }

  figcaption {
    text-align: center;
    font-style: italic;
    margin-top: 0.5em;
    color: #8c53cf;
    font-style: italic;
  }

  /* Add new styles for copy button */
  pre[data-role="codeBlock"] {
    position: relative;
  }

  .copy-button {
    position: absolute;
    bottom: 8px;
    right: 5px;
    padding: 4px 8px;
    font-size: 12px;
    background: rgba(255, 255, 255, 0.8);
    border: 1px solid #ddd;
    border-radius: 3px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
    z-index: 1000;
  }

  /* Show buttons on hover */
  pre[data-role="codeBlock"]:hover .copy-button,
  figure:hover .img-copy-button {
    opacity: 0.7;
  }

  .copy-button:hover,
  .img-copy-button:hover {
    opacity: 1 !important;
  }

  /* Add styles for image copy button */
  figure {
    position: relative;
  }

  .img-copy-button {
    position: absolute;
    bottom: 5px;
    right: 5px;
    padding: 4px 8px;
    font-size: 12px;
    background: rgba(255, 255, 255, 0.8);
    border: 1px solid #ddd;
    border-radius: 3px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
    z-index: 1000;
  }

  /* Show buttons on hover */
  figure:hover .img-copy-button {
    opacity: 0.7;
  }

  .img-copy-button:hover {
    opacity: 1 !important;
  }
</style>